import { getWeekTideData } from 'backend/mare-semanal';
import { getWeekMoonData } from 'backend/lua-semanal';

$w.onReady(function () {
    console.log("=== P√ÅGINA CARREGADA ===");
    iniciarWidgets();
});

function iniciarWidgets() {
    // Widget Lua
    $w("#luasemanal").onMessage((event) => {
        console.log("üì® Mensagem recebida:", event.data);
        
        if (event.data === "readyMoon") {
            console.log("üåô Widget lua pronto!");
            buscarLuaSemanal();
        }
        
        if (event.data === "moonReceived") {
            console.log("‚úÖ Lua renderizada com sucesso!");
        }
    });
    
    // Widget Mar√©s
    $w("#maresemanal").onMessage((event) => {
        console.log("üì® Mensagem recebida:", event.data);
        
        if (event.data === "readyTides") {
            console.log("üåä Widget mar√© pronto!");
            buscarMareSemanal();
        }
        
        if (event.data === "tidesReceived") {
            console.log("‚úÖ Mar√©s renderizadas com sucesso!");
        }
    });
}

function buscarLuaSemanal() {
    console.log("‚Üí Buscando dados da lua...");
    
    getWeekMoonData()
        .then((dados) => {
            console.log("‚Üê Dados da lua retornados:", dados);
            
            if (dados && Array.isArray(dados) && dados.length > 0) {
                console.log("‚Üí Enviando", dados.length, "dias para o widget");
                
                $w("#luasemanal").postMessage({
                    type: 'moon',
                    data: dados
                });
            } else {
                console.warn("‚ö†Ô∏è Dados da lua vazios ou inv√°lidos");
            }
        })
        .catch((erro) => {
            console.error("‚ùå ERRO ao buscar lua:", erro);
        });
}

function buscarMareSemanal() {
    console.log("‚Üí Buscando dados das mar√©s...");
    
    getWeekTideData()
        .then((dados) => {
            console.log("‚Üê Dados das mar√©s retornados:", dados);
            
            if (dados && Array.isArray(dados) && dados.length > 0) {
                console.log("‚Üí Enviando", dados.length, "registros para o widget");
                
                $w("#maresemanal").postMessage({
                    type: 'tides',
                    data: dados
                });
            } else {
                console.warn("‚ö†Ô∏è Dados das mar√©s vazios ou inv√°lidos");
            }
        })
        .catch((erro) => {
            console.error("‚ùå ERRO ao buscar mar√©s:", erro);
        });
}
