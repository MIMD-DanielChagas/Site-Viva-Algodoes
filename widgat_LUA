<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Montserrat', sans-serif; 
            margin: 0; 
            padding: 0;
            color: #4c6b5c; 
            background: transparent;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(76, 107, 92, 0.1);
        }
        
        .section-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #4c6b5c;
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 2px solid #d1ad6c;
            padding-bottom: 15px;
        }
        
        /* SE√á√ÉO LUA */
        .moon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .moon-day-card {
            background: linear-gradient(135deg, #f9f6f1 0%, #ffffff 100%);
            border: 2px solid #d1ad6c;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .moon-day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(209, 173, 108, 0.3);
        }
        
        .moon-day-card.today {
            background: linear-gradient(135deg, #d1ad6c 0%, #c09d5a 100%);
        }
        
        .moon-day-card.today * {
            color: white !important;
        }
        
        .day-name {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #4c6b5c;
            margin-bottom: 5px;
        }
        
        .day-date {
            font-size: 0.85em;
            color: #d1ad6c;
            margin-bottom: 10px;
        }
        
        .moon-icon {
            font-size: 2.5em;
            margin: 10px 0;
        }
        
        .moon-name {
            font-size: 0.85em;
            font-weight: 600;
            color: #d1ad6c;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
            line-height: 1.3;
        }
        
        .phase-change {
            font-size: 0.65em;
            color: #4c6b5c;
            margin-top: 8px;
            padding: 5px;
            background: rgba(209, 173, 108, 0.1);
            border-radius: 5px;
        }
        
        .moon-day-card.today .phase-change {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* SE√á√ÉO MAR√âS */
        .location-label {
            text-align: center;
            font-size: 0.95em;
            color: #4c6b5c;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tides-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 15px;
            margin: 0 -30px;
            padding: 0 30px;
        }
        
        .tides-chart-wrapper {
            min-width: 1400px;
        }
        
        .days-header {
            display: flex;
            margin-bottom: 10px;
            background: #f9f6f1;
            border-radius: 8px 8px 0 0;
            padding: 10px 0;
        }
        
        .day-header-item {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
        }
        
        .day-header-item.today {
            background: rgba(209, 173, 108, 0.2);
            border-radius: 6px;
        }
        
        .day-header-name {
            font-size: 0.8em;
            font-weight: 600;
            color: #4c6b5c;
            text-transform: uppercase;
            display: block;
            margin-bottom: 3px;
        }
        
        .day-header-date {
            font-size: 0.7em;
            color: #d1ad6c;
            display: block;
        }
        
        .chart-area {
            background: linear-gradient(to bottom, #e8f4f8 0%, #c5e3ed 100%);
            border-radius: 10px;
            padding: 20px;
            height: 150px;
        }
        
        .chart-canvas-container {
            position: relative;
            height: 100%;
        }
        
        .daily-summary {
            display: flex;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px 0;
        }
        
        .summary-day {
            flex: 1;
            text-align: center;
            padding: 0 8px;
            border-right: 1px solid rgba(209, 173, 108, 0.2);
        }
        
        .summary-day:last-child {
            border-right: none;
        }
        
        .summary-day.today {
            background: rgba(209, 173, 108, 0.1);
            border-radius: 6px;
        }
        
        .summary-tides {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .summary-tide {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }
        
        .summary-tide-label {
            font-size: 0.65em;
            color: #4c6b5c;
            opacity: 0.7;
            text-transform: uppercase;
        }
        
        .summary-tide-value {
            font-size: 0.75em;
            font-weight: 600;
            color: #d1ad6c;
        }
        
        .summary-tide-time {
            font-size: 0.65em;
            color: #4c6b5c;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #d1ad6c;
            font-size: 1.2em;
        }
        
        /* RESPONSIVIDADE */
        @media (max-width: 1200px) {
            .moon-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }
            
            .tides-chart-wrapper {
                min-width: 1200px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .section {
                padding: 20px 15px;
                margin-bottom: 20px;
            }
            
            .section-title {
                font-size: 1.4em;
            }
            
            .moon-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }
            
            .moon-day-card {
                padding: 12px;
                min-height: 160px;
            }
            
            .moon-icon {
                font-size: 2em;
            }
            
            .moon-name {
                font-size: 0.75em;
            }
            
            .tides-scroll-container {
                margin: 0 -15px;
                padding: 0 15px;
            }
            
            .tides-chart-wrapper {
                min-width: 1000px;
            }
            
            .day-header-name {
                font-size: 0.7em;
            }
            
            .day-header-date {
                font-size: 0.65em;
            }
            
            .summary-tide-value {
                font-size: 0.7em;
            }
            
            .summary-tide-time {
                font-size: 0.6em;
            }
        }
        
        @media (max-width: 480px) {
            .moon-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .section-title {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SE√á√ÉO LUA -->
        <div class="section">
            <h2 class="section-title">üåô Fases da Lua</h2>
            <div id="moon-content" class="loading">Carregando fases da lua...</div>
        </div>

        <!-- SE√á√ÉO MAR√âS -->
        <div class="section">
            <h2 class="section-title">üåä T√°bua de Mar√©s</h2>
            <div class="location-label">
                <span>üìç</span>
                <span>Praia de Algod√µes</span>
            </div>
            <div id="tides-content" class="loading">Carregando previs√£o de mar√©s...</div>
        </div>
    </div>

    <script>
        const moonMap = {
            'new moon': { name: 'Lua Nova', icon: 'üåë' },
            'waxing crescent': { name: 'Crescente', icon: 'üåí' },
            'first quarter': { name: 'Quarto Crescente', icon: 'üåì' },
            'waxing gibbous': { name: 'Crescente Gibosa', icon: 'üåî' },
            'full moon': { name: 'Lua Cheia', icon: 'üåï' },
            'waning gibbous': { name: 'Minguante Gibosa', icon: 'üåñ' },
            'last quarter': { name: 'Quarto Minguante', icon: 'üåó' },
            'waning crescent': { name: 'Lua Minguante', icon: 'üåò' },
            'third quarter': { name: 'Quarto Minguante', icon: 'üåó' }
        };

        const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        let continuousChart = null;
        let moonDataReceived = false;
        let tidesDataReceived = false;

        window.onload = () => {
            window.parent.postMessage("readyMoon", "*");
            window.parent.postMessage("readyTides", "*");
        };

        window.onmessage = (event) => {
            if (event.data && event.data.type === 'moon') {
                renderMoonWeek(event.data.data);
                moonDataReceived = true;
                if (moonDataReceived) window.parent.postMessage("moonReceived", "*");
            }
            
            if (event.data && event.data.type === 'tides') {
                processAndRenderTides(event.data.data);
                tidesDataReceived = true;
                if (tidesDataReceived) window.parent.postMessage("tidesReceived", "*");
            }
        };

        // LUA
        function renderMoonWeek(moonData) {
            const today = new Date().toDateString();
            let html = '<div class="moon-grid">';

            moonData.forEach((day) => {
                const date = new Date(day.date);
                const isToday = date.toDateString() === today;
                const phaseInfo = moonMap[day.phase.toLowerCase()] || { name: day.phase, icon: 'üåô' };
                const dayName = weekDays[date.getDay()];
                const dayDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });

                let phaseChangeHtml = '';
                
                if (day.nextPhases && day.nextPhases.length > 0) {
                    day.nextPhases.forEach(nextPhase => {
                        const phaseTime = new Date(nextPhase.time);
                        const phaseDate = new Date(phaseTime.getTime() - (3 * 60 * 60 * 1000));
                        
                        if (phaseDate.toDateString() === date.toDateString()) {
                            const nextPhaseInfo = moonMap[nextPhase.phase.toLowerCase()] || { name: nextPhase.phase, icon: 'üåô' };
                            const timeStr = phaseDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            phaseChangeHtml = `<div class="phase-change">${nextPhaseInfo.icon} ${nextPhaseInfo.name} √†s ${timeStr}</div>`;
                        }
                    });
                }

                html += `
                    <div class="moon-day-card ${isToday ? 'today' : ''}">
                        <div class="day-name">${dayName}</div>
                        <div class="day-date">${dayDate}</div>
                        <div class="moon-icon">${phaseInfo.icon}</div>
                        <div class="moon-name">${phaseInfo.name}</div>
                        ${phaseChangeHtml}
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('moon-content').innerHTML = html;
        }

        // MAR√âS
        function processAndRenderTides(extremes) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            extremes.sort((a, b) => new Date(a.time) - new Date(b.time));
            
            const allPoints = [];
            const startTime = new Date(extremes[0].time);
            const endTime = new Date(extremes[extremes.length - 1].time);
            const totalHours = (endTime - startTime) / (1000 * 60 * 60);
            const pointsPerHour = 10;
            const totalPoints = Math.floor(totalHours * pointsPerHour);
            
            for (let i = 0; i < totalPoints; i++) {
                const currentTime = new Date(startTime.getTime() + (i / pointsPerHour) * 60 * 60 * 1000);
                
                let before = extremes[0];
                let after = extremes[extremes.length - 1];
                
                for (let j = 0; j < extremes.length - 1; j++) {
                    const extremeTime = new Date(extremes[j].time);
                    const nextExtremeTime = new Date(extremes[j + 1].time);
                    
                    if (currentTime >= extremeTime && currentTime <= nextExtremeTime) {
                        before = extremes[j];
                        after = extremes[j + 1];
                        break;
                    }
                }
                
                const beforeTime = new Date(before.time).getTime();
                const afterTime = new Date(after.time).getTime();
                const timeDiff = afterTime - beforeTime;
                
                let height = before.height;
                
                if (timeDiff > 0) {
                    const progress = (currentTime - beforeTime) / timeDiff;
                    const smoothProgress = (1 - Math.cos(progress * Math.PI)) / 2;
                    height = before.height + (after.height - before.height) * smoothProgress;
                }
                
                allPoints.push({ time: currentTime, height: height });
            }
            
            const tidesByDay = [];
            for (let i = 0; i < 8; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
                const dayEnd = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);
                
                const dayExtremes = extremes.filter(e => {
                    const eTime = new Date(e.time);
                    return eTime >= dayStart && eTime <= dayEnd;
                });
                
                if (dayExtremes.length > 0 || i < 7) {
                    tidesByDay.push({ date: date, extremes: dayExtremes });
                }
            }
            
            renderTidesChart(tidesByDay, allPoints);
        }

        function renderTidesChart(tidesByDay, allPoints) {
            const today = new Date().toDateString();
            
            let html = '<div class="tides-scroll-container"><div class="tides-chart-wrapper">';
            
            html += '<div class="days-header">';
            tidesByDay.slice(0, 7).forEach(day => {
                const isToday = day.date.toDateString() === today;
                const dayName = weekDays[day.date.getDay()];
                const dayDate = day.date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                
                html += `
                    <div class="day-header-item ${isToday ? 'today' : ''}">
                        <span class="day-header-name">${dayName}</span>
                        <span class="day-header-date">${dayDate}</span>
                    </div>
                `;
            });
            html += '</div>';
            
            html += '<div class="chart-area"><div class="chart-canvas-container">';
            html += '<canvas id="continuous-tide-chart"></canvas>';
            html += '</div></div>';
            
            html += '<div class="daily-summary">';
            tidesByDay.slice(0, 7).forEach(day => {
                const isToday = day.date.toDateString() === today;
                const extremes = day.extremes;
                
                const highs = extremes.filter(e => e.type === 'high');
                const lows = extremes.filter(e => e.type === 'low');
                
                const firstHigh = highs[0];
                const firstLow = lows[0];

                html += `<div class="summary-day ${isToday ? 'today' : ''}"><div class="summary-tides">`;
                
                if (firstLow) {
                    const lowTime = new Date(firstLow.time);
                    const adjustedLow = new Date(lowTime.getTime() - (3 * 60 * 60 * 1000));
                    html += `
                        <div class="summary-tide">
                            <span class="summary-tide-label">‚Üì BAIXA</span>
                            <span class="summary-tide-value">${firstLow.height.toFixed(2)}m</span>
                            <span class="summary-tide-time">${adjustedLow.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                    `;
                }
                
                if (firstHigh) {
                    const highTime = new Date(firstHigh.time);
                    const adjustedHigh = new Date(highTime.getTime() - (3 * 60 * 60 * 1000));
                    html += `
                        <div class="summary-tide">
                            <span class="summary-tide-label">‚Üë ALTA</span>
                            <span class="summary-tide-value">${firstHigh.height.toFixed(2)}m</span>
                            <span class="summary-tide-time">${adjustedHigh.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                    `;
                }
                
                html += `</div></div>`;
            });
            html += '</div></div></div>';
            
            document.getElementById('tides-content').innerHTML = html;
            
            setTimeout(() => renderChart(allPoints), 100);
        }

        function renderChart(allPoints) {
            const ctx = document.getElementById('continuous-tide-chart');
            if (!ctx) return;
            
            if (continuousChart) continuousChart.destroy();

            continuousChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: allPoints.map(() => ''),
                    datasets: [{
                        data: allPoints.map(t => t.height),
                        borderColor: '#d1ad6c',
                        backgroundColor: 'rgba(209, 173, 108, 0.2)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2.5,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        y: { 
                            display: true,
                            grid: { display: false },
                            ticks: { 
                                color: '#4c6b5c',
                                font: { size: 10 },
                                callback: (val) => val.toFixed(1) + 'm'
                            }
                        },
                        x: { display: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
